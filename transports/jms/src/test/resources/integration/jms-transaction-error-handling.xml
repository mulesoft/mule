<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:context="http://www.springframework.org/schema/context"
      xmlns:vm="http://www.mulesoft.org/schema/mule/vm"
      xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:spring="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:amq="http://activemq.apache.org/schema/core"
      xmlns:test="http://www.mulesoft.org/schema/mule/test"
      xsi:schemaLocation="http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-current.xsd
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
    http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
    http://www.mulesoft.org/schema/mule/jms http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd
    http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd
    http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd
    http://www.mulesoft.org/schema/mule/test http://www.mulesoft.org/schema/mule/test/current/mule-test.xsd">

  <!--  Everything works-->

  <flow name="write-to-queue-everything-works">
    <vm:inbound-endpoint exchange-pattern="one-way" path="in-everything-works" />
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-in-everything-works" />
  </flow>

  <flow name="everything-works">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-in-everything-works">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:inbound-endpoint>
    <jms:outbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <append-string-transformer message=", world!"/>
    <test:component throwException="false"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-out">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <catch-exception-strategy>
      <set-payload value="An error occurred!"/>
      <test:component throwException="false"/>
      <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-error">
        <jms:transaction action="BEGIN_OR_JOIN" />
      </jms:outbound-endpoint>
    </catch-exception-strategy>
  </flow>

  <!--  Everything works simple-->

  <flow name="write-to-queue-everything-works-simple">
    <vm:inbound-endpoint exchange-pattern="one-way" path="in-everything-works-simple"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-in-everything-works-simple" />
  </flow>

  <flow name="everything-works-simple">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-in-everything-works-simple">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:inbound-endpoint>
    <jms:outbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <append-string-transformer message=", world!"/>
    <test:component throwException="false"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-out-simple">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
  </flow>

  <!--  Error in use case-->

  <flow name="write-to-queue-error-in-use-case">
    <vm:inbound-endpoint exchange-pattern="one-way" path="in-error-in-use-case" />
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-in-error-in-use-case" />
  </flow>

  <flow name="error-in-usecase">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-in-error-in-use-case">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:inbound-endpoint>
    <jms:outbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <append-string-transformer message=", world!"/>
    <test:component throwException="true"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-out">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <catch-exception-strategy>
      <set-payload value="An error occurred!"/>
      <test:component throwException="false"/>
      <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-error">
        <jms:transaction action="BEGIN_OR_JOIN" />
      </jms:outbound-endpoint>
    </catch-exception-strategy>
  </flow>

  <!--  Error in use case simple-->

  <flow name="write-to-queue-error-use-case-simple">
    <vm:inbound-endpoint exchange-pattern="one-way" path="in-error-in-use-case-simple"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-in-error-use-case-simple" />
  </flow>

  <flow name="error-use-case-simple">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-in-error-use-case-simple">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:inbound-endpoint>
    <jms:outbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <append-string-transformer message=", world!"/>
    <test:component throwException="true"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-out-simple">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
  </flow>

  <!--  Error in use case and in exception handler-->

  <flow name="write-to-queue-error-in-use-case-and-eh">
    <vm:inbound-endpoint exchange-pattern="one-way" path="in-error-in-use-case-and-eh" />
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-in-error-in-use-case-and-eh" />
  </flow>

  <flow name="error-in-usecase-and-eh">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-in-error-in-use-case-and-eh">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:inbound-endpoint>
    <jms:outbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <append-string-transformer message=", world!"/>
    <test:component throwException="true"/>
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-out">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <catch-exception-strategy>
      <set-payload value="An error occurred!"/>
      <test:component throwException="true"/>
      <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-error">
        <jms:transaction action="BEGIN_OR_JOIN" />
      </jms:outbound-endpoint>
    </catch-exception-strategy>
  </flow>

  <!--  Error in use case and in exception handler flowref -->

  <flow name="write-to-queue-error-in-use-case-and-eh-flowref">
    <vm:inbound-endpoint exchange-pattern="one-way" path="in-error-in-use-case-and-eh-flowref" />
    <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-in-error-in-use-case-and-eh-flowref" />
  </flow>

  <flow name="error-in-usecase-and-eh-flowref">
    <jms:inbound-endpoint queue="test-queue-in-error-in-use-case-and-eh-flowref" connector-ref="connector1">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:inbound-endpoint>
    <jms:outbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
    <append-string-transformer message=", world!"/>
    <flow-ref name="flowref-usecase"/>
    <jms:outbound-endpoint queue="test-queue-out-simple" connector-ref="connector1">
      <jms:transaction action="BEGIN_OR_JOIN" />
    </jms:outbound-endpoint>
  </flow>

  <flow name="flowref-usecase">
    <test:component throwException="true"/>
    <catch-exception-strategy>
      <set-payload value="An error occurred!"/>
      <test:component throwException="true"/>
      <jms:outbound-endpoint connector-ref="connector1" queue="test-queue-error">
        <jms:transaction action="BEGIN_OR_JOIN" />
      </jms:outbound-endpoint>
    </catch-exception-strategy>
  </flow>

  <!--  Output -->

  <flow name="read-from-error-queue">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-error" />
    <set-property propertyName="error" value="#[message.inboundProperties.error]"/>
    <vm:outbound-endpoint exchange-pattern="one-way" path="error"/>
  </flow>

  <flow name="read-from-out-queue">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-out" />
    <vm:outbound-endpoint exchange-pattern="one-way" path="out"/>
  </flow>

  <flow name="read-from-out-queue-simple">
    <jms:inbound-endpoint connector-ref="connector1" queue="test-queue-out-simple" />
    <vm:outbound-endpoint exchange-pattern="one-way" path="out-simple"/>
  </flow>

  <flow name="transacted-queue">
    <jms:inbound-endpoint connector-ref="connector1" queue="queued-before-flow-transformer" />
    <vm:outbound-endpoint exchange-pattern="one-way" path="check-transacted" />
  </flow>

</mule>
